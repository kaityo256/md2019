
## 時間積分とは何か
# 分子動力学法における時間積分

何か物理系が、変数の組$\vec{x} = (x_1, x_2, \cdots)$で記述されているとしよう。この変数が時間に依存しており、その時間微分$\dot{\vec{x}}$が、$\vec{x}$の関数として書かれている時、この系を *力学系(Dynamical System)* と呼ぶ。特に、外力がなく、系を記述する変数だけで方程式が閉じている時、この系を *自励的(autonomous)* と言う。以下、自励的な系のみを扱う。

我々は、時刻$t=0$における系の状態$\vec{x}(0)$を指定した時、任意の時刻$t$の系の状態$\vec{x}(t)$を知りたい。このような問題設定を初期値問題と呼び、数値計算における基本課題となっている。以下、簡単のために一次元系で考えよう。方程式は以下のように表現されている。

$$
\frac{dx }{dt} = f(x)
$$

これを形式的に積分すると、任意の時刻$t$における$x$の値は以下のように求めることができる。

$$
x(t) = x(0) + \int_0^t f(x) dt
$$

さて、右辺の積分は一般には厳密に求積することはできない。そこでなんらかの近似を行うことにしよう。最も簡単な近似は、短い時間$h$の間であれば$f(t)$はあまり変化しないと思って、定数として扱ってしまうことであろう。

$$
x(t+h) = x(t) + \int_t^{t+h} f(x) dt \sim x(t) + f(x)h
$$

こうして、$x(t)$から$x(t+h)$が求まるので、$t=0$から$h$刻みで次々と状態を更新していけば、任意の時刻の$x(t)$を求めることができる。このような方法を数値積分と呼び、特に今回の積分方法はオイラー法と呼ばれる。

このオイラー法の精度を調べてみよう。$x(t+h)$を$t$のまわりでテイラー展開してみよう。

$$
x(t + h) = x(t) + \dot{x}(t) h + O(h^2)
$$

ここで、$\dot{x} = f(x)$であったから、

$$
x(t + h) = x(t) + f(x) h + O(h^2)
$$

オイラー法は、$h$に関して一次まで正しい。これを一次精度であると呼ぶ。さて、オイラー法は非常に精度が悪く、数値解が指数関数的に厳密解から離れていくことが知られている。

さて、オイラー法は、本来は時刻$t$から$t+h$まで時々刻々と変化する微分係数$f(x)$を、時刻$t$での値で代表させたのだが、さすがにこれは乱暴に過ぎた。そこで、時間刻み$h$ではなく、その中点$h/2$での時間微分を使うことにしよう。

まず、系を一次のオイラー法で$h/2$だけ時刻を進める。すると、その場所$x_m$は

$$
x_m = x(t) + \frac{f(x)h}{2}
$$

となる。この地点での微分係数$f(x_m)$を使って、あらためて現在地点$x(t)$から$x(t+h)$の位置を推定すると、

$$
x(t+h) = x(t) + f(x_m) h
$$

となる。これは中点法と呼ばれ、二次精度となる。念の為に確認しておこう。$x(t+h)$を二次までテイラー展開しよう。

$$
\begin{aligned}
\ddot{x} &= \frac{df}{dt} \\
&=\frac{df}{dx} \frac{dx}{dt}  \\
&= f'(x) f(x)
\end{aligned}
$$

であることに注意すると、

$$
\begin{aligned}
x(t+h) &= x(t) + \dot{x}(t) h + \frac{\ddot{x}h^2}{2} +O(h^3)\\
&= x(t) + f(x) h + \frac{f'(x)f(x)h^2}{2} +O(h^3)
\end{aligned}
$$

となる。また、中点法は、

$$
\begin{aligned}
x(t+h) &= x(t) + f(x_m) h \\
&= x(t) + f\left( x(t) + \frac{f(x)h}{2} \right)h \\
&= x(t) + f(x)h + \frac{f'(x) f(x)h^2}{2} + O(h^3)
\end{aligned}
$$
となり、$x(t+h)$のテイラー展開と$h$の二次まで一致する。ここでは中点を一つだけとったが、これを4点とるのが古典的なRunge-Kutta法であり、比較的実装が容易で4次精度と精度が高いために広く使われている。

その他、これまでの軌跡を覚えておいて、そこから線形補完して場所を予測し、予測点を使って改めて将来の点を修正する、予測子-修正子法も広く使われている。

## 運動方程式の時間積分

### オイラー法

さて、分子動力学法の運動方程式を考えよう。簡単のために一次元系を考える。ハミルトニアン$H(p,q)$に支配されている系の運動方程式は以下のように書けるのだった。

$$
\begin{aligned}
\dot{p} &= - \frac{\partial H}{\partial q} \\
\dot{q} &= \frac{\partial H}{\partial p} \\
\end{aligned}
$$

この系は$(p,q)$の変数の組で記述されており、ハミルトニアン$H$は$p,q$の関数であるから、変数の時間微分が自身の関数として表現されている。つまり、ハミルトンの運動方程式も力学系である。力学系であるから、通常の常微分方程式の数値積分法を使うことができる。

いま、系として調和振動子を考えよう。ハミルトニアンは$H=p^2/2 + q^2/2$であり、運動方程式は以下のように書ける。

$$
\begin{aligned}
\dot{p} &= - q \\
\dot{q} &= p \\
\end{aligned}
$$

さて、運動方程式における初期値問題とは、ある時刻$t=0$における初期値$(p(0),q(0))$から、任意の時刻$t$における値$(p(t),q(t))$を求めることである。まず、オイラー法を適用してみよう。時刻$t$の時の微分係数を使って$t+h$の座標を予測するのであるから、

$$
\begin{aligned}
p(t+h) &= p - q h \\
q(t+h) &= q + p h \\
\end{aligned}
$$

と求めることができる。なお、煩雑なので$p(t)$や$q(t)$は$p$、$q$と記述した。さて、時間非依存なハミルトンの運動方程式は、

$$
\dot{H} = \frac{\partial H}{\partial p} \dot{p} + \frac{\partial H}{\partial q} \dot{q} = 0
$$

であるから、ハミルトニアンが保存量となる。調和振動子系なら、$p^2/2+q^2/2$が保存されなければならない。計算してみよう。

$$
p(t+h)^2 + q(t+h)^2 = (p-qh)^2 + (q + ph)^2 = (1+h^2)(p^2+q^2)
$$

つまり、時刻$t$においてエネルギーが$p^2+q^2$であった系は、1ステップ後に$(1+h^2)$倍に、$n$ステップ進むと$(1+h^2)^n$倍になる。「オイラー法が厳密解から指数関数的にずれる」という意味がわかるであろう。

### Velocity Verlet法

さて、調和振動子の運動方程式をオイラー法で数値積分するとエネルギーがあっという間に発散することがわかった。そこで、Runge-Kuttaや予測子-修正子法のような高次の数値積分法を使っても良いのだが、より簡便で、かつ非常に安定な数値積分法が発見された。velocity Verlet (VV)法である。以下の運動方程式を考えよう。

$$
\begin{aligned}
\dot{p} &= f \\
\dot{q} &= p \\
\end{aligned}
$$

簡単のために一次元系で、質量を1としている。$f(q)$は力であり、ポテンシャル$V(q)$によるものなら$f(q) = -V'(q)$である。この運動方程式に対して、VV法は、以下のように構成される。

まず、位置については、二次までテイラー展開する。

$$
\begin{aligned}
q(t+h) &= q(t) + \dot{q}(t) h + \frac{\ddot{q}(t)h^2}{2} \\
&= q + p h + \frac{f h^2}{2}
\end{aligned}
$$

ここで、運動方程式では位置の時間微分は速度、速度(運動量)の時間微分は力であるから、それぞれ既知なのがミソである。

速度も二次まで展開したいが、速度の微分は力であり、力の微分まで計算するのは面倒だ。そこで、差分を工夫する。先程、すでに時刻$t+h$における位置$q(t+h)$がわかっているので、その場所における力$f(t+h)$を使うことができる。すると、

$$
p(t+h) = p + \frac{f(t+h)+ f(t)}{2}h
$$

と表すことができる。これが二次まで正しいテイラー展開になっていることは容易に確認できるであろう。

さて、このようにして構築されたVV法は、位置に関しても運動量に関しても二次まで正しい展開になっているため、二次精度の数値積分法になっていることが予想される。事実、VV法は二次精度なのだが、この時間発展を行うと **エネルギーが厳密に保存する**。

実際に調和振動子系で確認してみよう。VV法を適用すると

$$
\begin{aligned}
q(t+h) &= q + p h - \frac{q h^2}{2} \\
&= h p + \left( 1 - \frac{h^2}{2}\right)q \\
p(t+h) &= p - \frac{q(t+h) + q(t)}{2} h\\
&= \left(1 - \frac{h}{2}\right)p + \left(-h + \frac{h^3}{4} \right)q \end{aligned}
$$

エネルギーの保存を確認すると、

$$
p(t+h)^2 + q(t+h)^2 = p^2 + q^2
$$

となっており、VV法はステップが進んでもエネルギーが厳密に保存される。実はVV法は、シンプレクティック積分と呼ばれる手法の一種になっている。シンプレクティック積分は、軌道は厳密解からずれるものの、エネルギーが厳密に保存するために長時間の安定した計算を可能とするため、分子動力学法で広く使われている。

以下ではシンプレクティック積分について紹介する。

TODO:調和振動子の行列表示

TODO:リュービル演算子と指数分解公式

TODO:VV法がシンプレクティック積分になっていることの証明
